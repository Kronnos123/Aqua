<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aqua Esmeralda Beach Club - Reservas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ccefff, #f0faff);
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 10px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        header {
            font-size: clamp(1.8rem, 5vw, 2.6rem);
            font-weight: 700;
            color: #05668d;
            margin: 1.5rem 0 0.5rem 0;
            user-select: none;
            text-align: center;
            width: 100%;
            padding: 0 10px;
            transition: color 0.3s ease;
        }

        .date-container {
            margin: 0.5rem 0 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

            .date-container label {
                font-weight: 600;
                color: #034a61;
                transition: color 0.3s ease;
            }

            .date-container input {
                padding: 8px 12px;
                border-radius: 8px;
                border: 1px solid #a1c3d1;
                font-family: 'Inter', sans-serif;
                font-size: 1rem;
                background: white;
                transition: all 0.3s ease;
            }

        .container {
            width: 100%;
            max-width: 680px;
            padding: 0 20px 60px;
        }

        .section {
            margin-bottom: 1.8rem;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 8px 14px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #ccc;
        }

            .section.expanded {
                box-shadow: 0 14px 30px rgba(5, 102, 141, 0.3);
            }

        .section-header {
            width: 100%;
            background: #0487a0;
            color: white;
            border: none;
            padding: 16px 20px;
            font-size: clamp(1.1rem, 3vw, 1.35rem);
            font-weight: 700;
            text-align: left;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

            .section-header:hover,
            .section-header:focus {
                background-color: #036b80;
                transform: scale(1.02);
                box-shadow: 0 6px 14px rgba(3,107,128,0.5);
                outline: none;
            }

        .section-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.4s ease;
            background: #f7fcff;
            border-radius: 0 0 12px 12px;
            padding: 0 15px;
        }

            .section-content.active {
                max-height: 1000px;
                opacity: 1;
                transform: translateY(0);
                padding: 15px;
                box-shadow: inset 0 2px 8px rgba(5, 102, 141, 0.1);
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed;
        }

        thead {
            background: #036b80;
            color: white;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            font-size: clamp(0.8rem, 2vw, 1rem);
            word-break: break-word;
            transition: all 0.3s ease;
        }

        tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

            tbody tr.pending {
                background: #d9e9f7;
                color: #036b80;
            }

            tbody tr.arrived {
                background: #c9e6b9;
                color: #2e6b26;
            }

            tbody tr.cancelled {
                background: #f9d6d5;
                color: #9c2b25;
                text-decoration: line-through;
            }

            tbody tr:hover {
                transform: scale(1.01);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

        .count {
            min-width: 28px;
            height: 28px;
            font-size: 1rem;
            font-weight: 700;
            color: white;
            background: #ef476f;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px #ef476faa;
            margin-left: 12px;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: #028090;
            border: none;
            color: white;
            padding: 12px 0;
            font-size: clamp(1rem, 3vw, 1.15rem);
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin: 10px 0 0;
            font-weight: 600;
        }

            .add-btn:hover,
            .add-btn:focus {
                background: #05668d;
                transform: scale(1.02);
                outline: none;
                box-shadow: 0 4px 12px rgba(5, 102, 141, 0.3);
            }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

            .modal.active {
                display: flex;
                opacity: 1;
            }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 14px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            color: #05668d;
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 4vw, 1.9rem);
            transition: color 0.3s ease;
        }

        .modal-content label {
            display: block;
            margin: 12px 0 6px;
            font-weight: 600;
            color: #034a61;
            transition: color 0.3s ease;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 10px 12px;
            font-size: 1rem;
            border-radius: 7px;
            border: 1.5px solid #a1c3d1;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

            .modal-content input:focus,
            .modal-content select:focus {
                outline: none;
                border-color: #028090;
                box-shadow: 0 0 6px #028090bb;
            }

        .modal-content button[type="submit"] {
            margin-top: 20px;
            width: 100%;
            background: #028090;
            color: white;
            font-weight: 700;
            padding: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1.1rem;
        }

            .modal-content button[type="submit"]:hover {
                background: #036b80;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(3, 107, 128, 0.3);
            }

        .close-btn {
            margin-top: 12px;
            width: 100%;
            background: #a1c3d1;
            color: #034a61;
            font-weight: 600;
            padding: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

            .close-btn:hover {
                background: #7ca6b5;
                transform: translateY(-2px);
                box-shadow: 0 2px 6px rgba(124, 166, 181, 0.3);
            }

        #total-general {
            max-width: 680px;
            margin: 0 auto 40px;
            font-weight: 700;
            font-size: clamp(1.1rem, 3vw, 1.35rem);
            color: #034a61;
            text-align: right;
            padding: 0 20px;
            width: 100%;
            transition: color 0.3s ease;
        }

        .floating-menu {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1100;
        }

        .menu-button {
            background: #05668d;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            border: none;
            position: relative;
            z-index: 1101;
        }

            .menu-button:hover {
                background: #034a61;
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0,0,0,0.2);
            }

            .menu-button.active {
                transform: rotate(90deg);
                background: #034a61;
            }

        .menu-options {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            min-width: 160px;
            display: none;
            flex-direction: column;
            gap: 5px;
            transform: translateY(-10px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1100;
        }

            .menu-options.active {
                display: flex;
                opacity: 1;
                transform: translateY(0);
            }

            .menu-options button {
                background: none;
                border: none;
                padding: 8px 12px;
                font-family: 'Inter', sans-serif;
                color: #034a61;
                cursor: pointer;
                border-radius: 6px;
                text-align: left;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s ease;
            }

                .menu-options button:hover {
                    background: #f0faff;
                    transform: translateX(3px);
                }

                .menu-options button i {
                    font-size: 1.1rem;
                    width: 20px;
                    text-align: center;
                }

        #search-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

            #search-container.active {
                display: flex;
                opacity: 1;
            }

        #search-form {
            background: white;
            padding: 25px;
            border-radius: 14px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        #search-container.active #search-form {
            transform: translateY(0);
        }

        #search-form h3 {
            color: #05668d;
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 4vw, 1.9rem);
        }

        #search-form input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 7px;
            border: 1.5px solid #a1c3d1;
            margin-bottom: 10px;
            font-family: 'Inter', sans-serif;
        }

        #search-button {
            background: #028090;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 7px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }

            #search-button:hover {
                background: #036b80;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(3, 107, 128, 0.3);
            }

        #search-results {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .search-result-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

            .search-result-item:hover {
                transform: translateX(3px);
            }

        .search-result-header {
            font-weight: 700;
            color: #05668d;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-result-details {
            font-size: 0.9rem;
            color: #555;
        }

            .search-result-details div {
                margin-top: 5px;
                padding: 5px 0;
                border-bottom: 1px dashed #eee;
            }

                .search-result-details div:last-child {
                    border-bottom: none;
                }

        .autocomplete {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #a1c3d1;
            border-radius: 0 0 7px 7px;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

            .autocomplete-items div {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                transition: all 0.2s ease;
            }

                .autocomplete-items div:hover {
                    background-color: #f0faff;
                }

        .autocomplete-active {
            background-color: #05668d !important;
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #05668d;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1200;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .toast.show {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            .toast.error {
                background: #ef476f;
            }

            .toast.success {
                background: #06d6a0;
            }

            .toast i {
                font-size: 1.2rem;
            }

        /* Modo oscuro */
        body.dark-mode {
            background: #121212;
            color: #f0f0f0;
        }

            body.dark-mode header {
                color: #48a6cb;
            }

            body.dark-mode .date-container label {
                color: #a1c3d1;
            }

            body.dark-mode .date-container input {
                background: #2b2b2b;
                color: #f0f0f0;
                border-color: #444;
            }

            body.dark-mode .section {
                background: #1e1e1e;
                border-color: #444;
            }

            body.dark-mode .section-header {
                background: #034a61;
            }

            body.dark-mode .section-content {
                background: #2b2b2b;
            }

            body.dark-mode table {
                color: #f0f0f0;
            }

            body.dark-mode thead {
                background: #023548;
            }

            body.dark-mode tbody tr.pending {
                background: #1a3a4a;
                color: #a1c3d1;
            }

            body.dark-mode tbody tr.arrived {
                background: #1e3a1e;
                color: #a6d8a6;
            }

            body.dark-mode tbody tr.cancelled {
                background: #3a1e1e;
                color: #d8a6a6;
            }

            body.dark-mode .modal-content,
            body.dark-mode #search-form,
            body.dark-mode .menu-options {
                background: #2b2b2b;
                color: #f0f0f0;
                border: 1px solid #444;
            }

                body.dark-mode .modal-content h3,
                body.dark-mode #search-form h3,
                body.dark-mode .search-result-header {
                    color: #48a6cb;
                }

                body.dark-mode .modal-content label,
                body.dark-mode #search-form label {
                    color: #f0f0f0;
                }

                body.dark-mode .modal-content input,
                body.dark-mode .modal-content select,
                body.dark-mode #search-form input {
                    background: #3b3b3b;
                    color: #f0f0f0;
                    border-color: #555;
                }

            body.dark-mode .close-btn {
                background: #3b3b3b;
                color: #f0f0f0;
            }

                body.dark-mode .close-btn:hover {
                    background: #4b4b4b;
                }

            body.dark-mode .autocomplete-items {
                background: #3b3b3b;
                border-color: #555;
            }

                body.dark-mode .autocomplete-items div {
                    border-color: #555;
                    color: #f0f0f0;
                }

                    body.dark-mode .autocomplete-items div:hover {
                        background-color: #4b4b4b;
                    }

            body.dark-mode .search-result-header {
                color: #48a6cb;
            }

            body.dark-mode .search-result-details {
                color: #bbb;
            }

                body.dark-mode .search-result-details div {
                    border-color: #444;
                }

            body.dark-mode #total-general {
                color: #a1c3d1;
            }

            body.dark-mode input[type="time"]::-webkit-calendar-picker-indicator {
                filter: invert(1);
            }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 0 15px 50px;
            }

            .section-header {
                padding: 14px 16px;
            }

            th, td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }

                td:nth-child(5) {
                    font-size: 0.75rem;
                }

            .modal-content {
                padding: 20px;
            }

            .menu-button {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }

            .menu-options {
                top: 50px;
            }

            .toast {
                width: 90%;
                text-align: center;
                justify-content: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>Aqua Esmeralda Beach Club</header>
    <div class="date-container">
        <label for="calendar">Fecha de reservas:</label>
        <input type="date" id="calendar" />
    </div>
    <main class="container">
        <section id="vip" class="section">
            <button class="section-header" id="vip-header">
                <span>Reservas VIP</span>
                <span class="count" id="vip-count">0</span>
            </button>
            <div class="section-content" id="vip-content">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn">Agregar Reserva</button>
            </div>
        </section>
        <section id="regular" class="section">
            <button class="section-header" id="regular-header">
                <span>Reservas Regular</span>
                <span class="count" id="regular-count">0</span>
            </button>
            <div class="section-content" id="regular-content">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn">Agregar Reserva</button>
            </div>
        </section>
        <section id="restaurante" class="section">
            <button class="section-header" id="restaurante-header">
                <span>Reservas Restaurante</span>
                <span class="count" id="restaurante-count">0</span>
            </button>
            <div class="section-content" id="restaurante-content">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn">Agregar Reserva</button>
            </div>
        </section>
    </main>

    <div id="total-general">
        Total general de personas (sin reservas canceladas): 0
    </div>

    <div id="form-container" class="modal">
        <div class="modal-content">
            <form id="form">
                <h3 id="form-title">Agregar reserva</h3>
                <div class="autocomplete">
                    <label for="input-nombre">Nombre</label>
                    <input id="input-nombre" name="nombre" type="text" autocomplete="off" required />
                    <div id="nombre-autocomplete" class="autocomplete-items"></div>
                </div>

                <label for="input-carnet">Carnet (opcional)</label>
                <input id="input-carnet" name="carnet" type="text" autocomplete="off" />

                <label for="input-hora">Hora</label>
                <input id="input-hora" name="hora" type="time" required />

                <label for="input-personas">Personas</label>
                <input id="input-personas" name="personas" type="number" min="1" max="20" required />

                <label for="input-estado">Estado</label>
                <select id="input-estado" name="estado" required>
                    <option value="pending">Pendiente</option>
                    <option value="arrived">Llegó</option>
                    <option value="cancelled">Cancelado</option>
                </select>

                <button type="submit">Guardar</button>
                <button type="button" class="close-btn">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="search-container" class="modal">
        <div class="modal-content">
            <form id="search-form">
                <h3><i class="fas fa-search"></i> Buscar Cliente</h3>
                <label for="search-input">Nombre del cliente:</label>
                <input type="text" id="search-input" placeholder="Escribe el nombre..." />
                <button type="button" id="search-button">Buscar</button>
                <div id="search-results"></div>
                <button type="button" class="close-btn">Cerrar</button>
            </form>
        </div>
    </div>

    <div class="floating-menu">
        <button class="menu-button">⋮</button>
        <div class="menu-options">
            <button id="dark-mode-toggle"><i class="fas fa-moon"></i> Modo oscuro</button>
            <button id="search-toggle"><i class="fas fa-search"></i> Buscar cliente</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Configuración
        const API_URL = 'https://script.google.com/macros/s/AKfycbzf0YCqkbOZZ0I6DgnXzbBQJwP6E5CkHlbiTUxxsa5R-Kc7z9YQhgW9m9YpDIH47zg4/exec';
        const sections = ['vip', 'regular', 'restaurante'];
        let currentDate = new Date().toISOString().split('T')[0];
        let editSection = null;
        let editIndex = null;
        let data = {};
        let isOnline = true;

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            initAccordions();
            setupEventListeners();
            checkConnection();
            loadAllData();

            // Configurar calendario
            const calendar = document.getElementById('calendar');
            calendar.value = currentDate;
            calendar.addEventListener('change', (e) => {
                currentDate = e.target.value;
                loadDataForDate(currentDate);
            });

            // Iniciar modo oscuro si estaba activo
            if (localStorage.getItem('darkMode') === '1') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').innerHTML = '<i class="fas fa-sun"></i> Modo claro';
            }
        });

        // Funciones principales
        function initAccordions() {
            sections.forEach(section => {
                const header = document.getElementById(`${section}-header`);
                const content = document.getElementById(`${section}-content`);

                header.addEventListener('click', () => {
                    const isExpanded = content.classList.toggle('active');
                    header.setAttribute('aria-expanded', isExpanded);
                });
            });
        }

        function setupEventListeners() {
            // Botones agregar
            sections.forEach(section => {
                document.querySelector(`#${section} .add-btn`).addEventListener('click', () => {
                    openAddForm(section);
                });
            });

            // Formulario
            document.getElementById('form').addEventListener('submit', handleFormSubmit);
            document.querySelector('#form .close-btn').addEventListener('click', closeForm);

            // Búsqueda
            document.getElementById('search-button').addEventListener('click', searchClient);
            document.querySelector('#search-form .close-btn').addEventListener('click', closeSearch);
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchClient();
                }
            });

            // Menú flotante
            const menuButton = document.querySelector('.menu-button');
            const menuOptions = document.querySelector('.menu-options');

            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                menuButton.classList.toggle('active');
                menuOptions.classList.toggle('active');
            });

            // Opciones del menú
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
            document.getElementById('search-toggle').addEventListener('click', openSearch);

            // Cerrar menú al hacer clic fuera
            document.addEventListener('click', () => {
                menuOptions.classList.remove('active');
                document.querySelector('.menu-button').classList.remove('active');
            });

            // Evitar que el menú se cierre al hacer clic dentro
            menuOptions.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Autocompletado
            document.getElementById('input-nombre').addEventListener('input', showAutocomplete);
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'input-nombre') {
                    document.getElementById('nombre-autocomplete').style.display = 'none';
                }
            });

            // Verificar conexión periódicamente
            setInterval(checkConnection, 30000);
        }

        function checkConnection() {
            isOnline = navigator.onLine;
            if (!isOnline) {
                showToast('Estás trabajando sin conexión. Los cambios se sincronizarán cuando vuelvas a estar en línea.', 'error');
            }
        }

        async function loadAllData() {
            try {
                if (!isOnline) {
                    const savedData = localStorage.getItem('beachClubData');
                    if (savedData) {
                        data = JSON.parse(savedData);
                        loadDataForDate(currentDate);
                    }
                    return;
                }

                const response = await fetch(`${API_URL}?operation=getData`);
                if (!response.ok) throw new Error('Error al cargar datos');
                data = await response.json();
                localStorage.setItem('beachClubData', JSON.stringify(data));
                loadDataForDate(currentDate);
            } catch (error) {
                console.error('Error:', error);
                const savedData = localStorage.getItem('beachClubData');
                if (savedData) {
                    data = JSON.parse(savedData);
                    loadDataForDate(currentDate);
                }
                showToast('Error al cargar datos. Usando caché local.', 'error');
            }
        }

        function loadDataForDate(date) {
            currentDate = date;
            if (!data[date]) {
                data[date] = { vip: [], regular: [], restaurante: [] };
            }
            sections.forEach(section => renderSection(section));
            updateTotalGeneral();
        }

        function renderSection(section) {
            const tbody = document.querySelector(`#${section} tbody`);
            tbody.innerHTML = '';

            const sectionData = data[currentDate]?.[section] || [];

            sectionData.forEach((reserva, index) => {
                const tr = document.createElement('tr');
                tr.className = reserva.estado;
                tr.innerHTML = `
          <td>${reserva.nombre}</td>
          <td>${reserva.carnet || ''}</td>
          <td>${reserva.hora}</td>
          <td>${reserva.personas}</td>
          <td>${getStatusText(reserva.estado)}</td>
        `;
                tr.addEventListener('click', () => openEditForm(section, index));
                tbody.appendChild(tr);
            });

            document.getElementById(`${section}-count`).textContent = sectionData.length;
        }

        function updateTotalGeneral() {
            let total = 0;
            sections.forEach(section => {
                (data[currentDate]?.[section] || []).forEach(reserva => {
                    if (reserva.estado !== 'cancelled') {
                        total += Number(reserva.personas);
                    }
                });
            });
            document.getElementById('total-general').textContent =
                `Total general de personas (sin reservas canceladas): ${total}`;
        }

        function getStatusText(status) {
            const statusMap = {
                pending: 'Pendiente',
                arrived: 'Llegó',
                cancelled: 'Cancelado'
            };
            return statusMap[status] || '';
        }

        // Funciones de formulario
        function openAddForm(section) {
            editSection = section;
            editIndex = null;

            const form = document.getElementById('form');
            form.reset();
            document.getElementById('form-title').textContent = `Agregar reserva en ${capitalize(section)}`;
            document.querySelector('#form button[type="submit"]').textContent = 'Agregar';

            // Establecer hora actual como predeterminada
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('input-hora').value = `${hours}:${minutes}`;

            document.getElementById('form-container').classList.add('active');
            document.getElementById('input-nombre').focus();
        }

        function openEditForm(section, index) {
            editSection = section;
            editIndex = index;

            const reserva = data[currentDate][section][index];
            const form = document.getElementById('form');

            document.getElementById('form-title').textContent = `Editar reserva en ${capitalize(section)}`;
            document.querySelector('#form button[type="submit"]').textContent = 'Guardar cambios';

            form.nombre.value = reserva.nombre;
            form.carnet.value = reserva.carnet || '';
            form.hora.value = reserva.hora;
            form.personas.value = reserva.personas;
            form.estado.value = reserva.estado;

            document.getElementById('form-container').classList.add('active');
            form.nombre.focus();
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const reserva = {
                nombre: form.nombre.value.trim(),
                carnet: form.carnet.value.trim() || null,
                hora: form.hora.value,
                personas: Number(form.personas.value),
                estado: form.estado.value
            };

            // Validación
            if (reserva.nombre.length < 3) {
                showToast('El nombre debe tener al menos 3 caracteres', 'error');
                return;
            }
            if (reserva.personas < 1 || reserva.personas > 20) {
                showToast('Número de personas inválido (1-20)', 'error');
                return;
            }

            // Verificar duplicados (solo para nuevas reservas)
            if (editIndex === null) {
                const hasDuplicate = checkDuplicateReservation(reserva);
                if (hasDuplicate) {
                    showToast('Esta persona ya tiene una reserva para esta fecha y sección', 'error');
                    return;
                }
            }

            try {
                // Guardar en Google Sheets si hay conexión
                if (isOnline) {
                    const operation = editIndex !== null ? 'updateReservation' : 'addReservation';
                    const params = {
                        operation,
                        date: currentDate,
                        section: editSection,
                        reservation: JSON.stringify(reserva)
                    };

                    if (operation === 'updateReservation') {
                        params.index = editIndex;
                    }

                    const response = await fetch(`${API_URL}?${new URLSearchParams(params)}`);
                    if (!response.ok) throw new Error('Error al guardar');
                }

                // Actualizar datos locales
                if (!data[currentDate]) data[currentDate] = { vip: [], regular: [], restaurante: [] };

                if (editIndex !== null) {
                    data[currentDate][editSection][editIndex] = reserva;
                    showToast('Reserva actualizada correctamente', 'success');
                } else {
                    data[currentDate][editSection].push(reserva);
                    showToast('Reserva agregada correctamente', 'success');
                }

                // Actualizar UI
                renderSection(editSection);
                updateTotalGeneral();
                closeForm();

                // Guardar en localStorage
                localStorage.setItem('beachClubData', JSON.stringify(data));

                // Si estaba sin conexión, intentar sincronizar
                if (!isOnline) {
                    showToast('Reserva guardada localmente. Se sincronizará cuando haya conexión.', 'success');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar la reserva. Por favor intenta nuevamente.', 'error');
            }
        }

        function checkDuplicateReservation(newReserva) {
            const sectionData = data[currentDate]?.[editSection] || [];
            return sectionData.some(reserva =>
                reserva.nombre.toLowerCase() === newReserva.nombre.toLowerCase() &&
                reserva.estado !== 'cancelled'
            );
        }

        function closeForm() {
            document.getElementById('form-container').classList.remove('active');
            editSection = null;
            editIndex = null;
        }

        // Búsqueda
        function openSearch() {
            document.getElementById('search-container').classList.add('active');
            document.getElementById('search-input').focus();
            document.querySelector('.menu-button').classList.remove('active');
            document.querySelector('.menu-options').classList.remove('active');
        }

        function closeSearch() {
            document.getElementById('search-container').classList.remove('active');
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('search-input').value = '';
        }

        function searchClient() {
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            if (!searchTerm) {
                showToast('Por favor ingresa un nombre para buscar', 'error');
                return;
            }

            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            const foundClients = {};

            // Buscar en todas las fechas y secciones
            for (const date in data) {
                sections.forEach(section => {
                    (data[date][section] || []).forEach(reserva => {
                        if (reserva.nombre.toLowerCase().includes(searchTerm)) {
                            if (!foundClients[reserva.nombre]) {
                                foundClients[reserva.nombre] = {
                                    carnet: reserva.carnet,
                                    reservations: []
                                };
                            }
                            foundClients[reserva.nombre].reservations.push({
                                date, section,
                                hora: reserva.hora,
                                personas: reserva.personas,
                                estado: reserva.estado
                            });
                        }
                    });
                });
            }

            // Mostrar resultados
            if (Object.keys(foundClients).length === 0) {
                resultsContainer.innerHTML = '<p>No se encontraron clientes con ese nombre.</p>';
                return;
            }

            for (const nombre in foundClients) {
                const client = foundClients[nombre];
                const clientElement = document.createElement('div');
                clientElement.className = 'search-result-item';

                let html = `
          <div class="search-result-header">
            <span>${nombre}</span>
            ${client.carnet ? `<span>Carnet: ${client.carnet}</span>` : ''}
          </div>
          <div class="search-result-details">
        `;

                // Ordenar por fecha (más reciente primero)
                client.reservations.sort((a, b) => new Date(b.date) - new Date(a.date));

                client.reservations.forEach(res => {
                    const fecha = new Date(res.date).toLocaleDateString('es-ES', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    });

                    html += `
            <div>
              <strong>${capitalizeFirstLetter(fecha)}</strong> - ${capitalize(res.section)} |
              ${res.hora} | ${res.personas} persona${res.personas > 1 ? 's' : ''} |
              ${getStatusText(res.estado)}
            </div>
          `;
                });

                html += '</div>';
                clientElement.innerHTML = html;
                resultsContainer.appendChild(clientElement);
            }
        }

        // Autocompletado
        function showAutocomplete() {
            const input = document.getElementById('input-nombre').value.trim();
            const autocompleteList = document.getElementById('nombre-autocomplete');
            autocompleteList.innerHTML = '';

            if (input.length < 2) {
                autocompleteList.style.display = 'none';
                return;
            }

            const names = new Set();

            // Buscar nombres similares
            for (const date in data) {
                sections.forEach(section => {
                    (data[date][section] || []).forEach(reserva => {
                        if (reserva.nombre.toLowerCase().includes(input.toLowerCase())) {
                            names.add(reserva.nombre);
                        }
                    });
                });
            }

            if (names.size === 0) {
                autocompleteList.style.display = 'none';
                return;
            }

            // Mostrar sugerencias
            names.forEach(name => {
                const item = document.createElement('div');
                item.textContent = name;
                item.addEventListener('click', () => {
                    document.getElementById('input-nombre').value = name;
                    autocompleteList.style.display = 'none';

                    // Buscar el carnet más reciente para este nombre
                    let latestReservation = null;
                    for (const date in data) {
                        sections.forEach(section => {
                            (data[date][section] || []).forEach(reserva => {
                                if (reserva.nombre === name && reserva.carnet) {
                                    if (!latestReservation || new Date(date) > new Date(latestReservation.date)) {
                                        latestReservation = reserva;
                                    }
                                }
                            });
                        });
                    }

                    if (latestReservation) {
                        document.getElementById('input-carnet').value = latestReservation.carnet;
                    }
                });
                autocompleteList.appendChild(item);
            });

            autocompleteList.style.display = 'block';
        }

        // Modo oscuro
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeBtn = document.getElementById('dark-mode-toggle');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', '1');
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> Modo claro';
            } else {
                localStorage.setItem('darkMode', '0');
                darkModeBtn.innerHTML = '<i class="fas fa-moon"></i> Modo oscuro';
            }
            document.querySelector('.menu-button').classList.remove('active');
            document.querySelector('.menu-options').classList.remove('active');
        }

        // Notificaciones toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.innerHTML = '';

            let icon = '';
            if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
            if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';

            toast.innerHTML = `${icon} ${message}`;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Utilidades
        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        function capitalizeFirstLetter(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }
    </script>
</body>
</html>