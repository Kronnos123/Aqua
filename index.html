<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aqua Esmeralda Beach Club - Reservas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ccefff, #f0faff);
            color: #222;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 10px;
        }

        header {
            font-size: 2.6rem;
            font-weight: 700;
            color: #05668d;
            margin: 1.5rem 0 0.5rem 0;
            user-select: none;
            text-align: center;
        }

        .date-container {
            margin: 0.5rem 0 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .date-container label {
                font-weight: 600;
                color: #034a61;
            }

            .date-container input {
                padding: 8px 12px;
                border-radius: 8px;
                border: 1px solid #a1c3d1;
                font-family: 'Inter', sans-serif;
                font-size: 1rem;
            }

        .container {
            width: 100%;
            max-width: 680px;
            padding: 0 20px 60px 20px;
        }

        .section {
            margin-bottom: 1.8rem;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 8px 14px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
            border: 1px solid #ccc;
        }

            .section.expanded {
                box-shadow: 0 14px 30px rgba(5, 102, 141, 0.3);
            }

        .section-header {
            width: 100%;
            background: #0487a0;
            color: white;
            border: none;
            padding: 18px 24px;
            font-size: 1.35rem;
            font-weight: 700;
            text-align: left;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-radius: 12px;
            transition: background-color 0.3s cubic-bezier(0.4,0,0.2,1), transform 0.2s cubic-bezier(0.4,0,0.2,1), box-shadow 0.3s ease;
            will-change: transform, box-shadow;
        }

            .section-header:hover,
            .section-header:focus {
                background-color: #036b80;
                transform: scale(1.03);
                box-shadow: 0 6px 14px rgba(3,107,128,0.5);
                outline: none;
            }

        .section-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(-8px);
            transition: max-height 0.5s cubic-bezier(0.4,0,0.2,1), opacity 0.35s ease, transform 0.35s ease;
            background: #f7fcff;
            border-radius: 0 0 12px 12px;
            padding: 0 24px;
        }

            .section-content.active {
                max-height: 800px;
                opacity: 1;
                transform: translateY(0);
                padding-top: 18px;
                padding-bottom: 25px;
                box-shadow: inset 0 2px 8px rgba(5, 102, 141, 0.1);
                display: block;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        thead {
            background: #036b80;
            color: white;
        }

        th, td {
            padding: 10px 14px;
            text-align: left;
            font-size: 1rem;
        }

        tbody tr {
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: inset 0 0 0 0 transparent;
            min-height: 48px;
        }

        tr.pending, .guest-pendiente {
            background: #d9e9f7;
            color: #036b80;
        }

        tr.arrived, .guest-llego {
            background: #c9e6b9;
            color: #2e6b26;
        }

        tr.cancelled, .guest-cancelado {
            background: #f9d6d5;
            color: #9c2b25;
            text-decoration: line-through;
        }

        tbody tr:hover,
        tbody tr:focus {
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            outline: none;
        }

        .guest-name {
            cursor: pointer;
            text-decoration: underline;
            color: #007bff;
        }

        button {
            margin: 10px;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            button:hover {
                background: #0056b3;
            }

        .add-btn {
            background: #028090;
            border: none;
            color: white;
            padding: 14px 0;
            font-size: 1.15rem;
            border-radius: 8px;
            cursor: pointer;
            width: calc(100% - 20px);
            margin: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

            .add-btn:hover,
            .add-btn:focus {
                background: #05668d;
                transform: scale(1.05);
                outline: none;
            }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

            .modal.active {
                display: flex;
                animation: fadeInBg 0.3s ease forwards;
            }

        @keyframes fadeInBg {
            from {
                background: rgba(0,0,0,0);
            }

            to {
                background: rgba(0,0,0,0.45);
            }
        }

        .modal-content {
            background: white;
            padding: 30px 32px;
            border-radius: 14px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            font-weight: 600;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

            .modal-content h3 {
                margin-top: 0;
                color: #05668d;
                margin-bottom: 22px;
                font-weight: 800;
                font-size: 1.9rem;
                user-select: none;
            }

            .modal-content label {
                display: block;
                margin: 12px 0 6px 0;
                font-weight: 700;
                color: #034a61;
            }

            .modal-content input,
            .modal-content select {
                width: 100%;
                padding: 10px 14px;
                font-size: 1rem;
                border-radius: 7px;
                border: 1.5px solid #a1c3d1;
                transition: border-color 0.3s ease;
                font-family: 'Inter', sans-serif;
                font-weight: 600;
            }

                .modal-content input:focus,
                .modal-content select:focus {
                    outline: none;
                    border-color: #028090;
                    box-shadow: 0 0 6px #028090bb;
                }

            .modal-content button[type="submit"] {
                margin-top: 26px;
                width: 100%;
                background: #028090;
                border: none;
                color: white;
                font-weight: 700;
                font-size: 1.25rem;
                padding: 14px 0;
                border-radius: 10px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

                .modal-content button[type="submit"]:hover,
                .modal-content button[type="submit"]:focus {
                    background: #036b80;
                    outline: none;
                }

        .close-btn {
            margin-top: 12px;
            width: 100%;
            background: #a1c3d1;
            border: none;
            color: #034a61;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 12px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            .close-btn:hover,
            .close-btn:focus {
                background: #7ca6b5;
                outline: none;
            }

        .hidden {
            display: none;
        }

        .total-box {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #total-general {
            max-width: 680px;
            margin: 0 auto 40px auto;
            font-weight: 700;
            font-size: 1.35rem;
            color: #034a61;
            user-select: none;
            text-align: right;
            padding: 0 20px;
        }

        .floating-menu {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }

        .menu-button {
            background: #05668d;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

            .menu-button:hover {
                background: #034a61;
                transform: scale(1.1) rotate(90deg);
            }

            .menu-button.active {
                transform: rotate(90deg);
            }

        .menu-options {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            transform: translateY(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

            .menu-options.active {
                transform: translateY(0);
                opacity: 1;
                visibility: visible;
            }

            .menu-options button {
                background: none;
                border: none;
                padding: 10px 12px;
                font-family: 'Inter', sans-serif;
                font-size: 1rem;
                color: #034a61;
                cursor: pointer;
                border-radius: 6px;
                width: 100%;
                text-align: left;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 0;
            }

                .menu-options button:hover {
                    background: #f0faff;
                    transform: translateX(5px);
                }

                .menu-options button i {
                    font-size: 1.2rem;
                }

        #search-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

            #search-container.active {
                display: flex;
                animation: fadeInBg 0.3s ease forwards;
            }

        #search-form {
            background: white;
            padding: 30px 32px;
            border-radius: 14px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            font-weight: 600;
            max-height: 80vh;
            overflow-y: auto;
        }

            #search-form h3 {
                margin-top: 0;
                color: #05668d;
                margin-bottom: 22px;
                font-weight: 800;
                font-size: 1.9rem;
                user-select: none;
            }

        #search-results {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

            .search-result-item:hover {
                background: #f7fcff;
            }

        .search-result-header {
            font-weight: 700;
            color: #05668d;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .search-result-details {
            font-size: 0.9rem;
            color: #555;
        }

            .search-result-details div {
                margin-top: 3px;
            }

        .autocomplete {
            position: relative;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #a1c3d1;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: 0 0 7px 7px;
        }

            .autocomplete-items div {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #a1c3d1;
            }

                .autocomplete-items div:hover {
                    background-color: #f0faff;
                }

        .autocomplete-active {
            background-color: #05668d !important;
            color: white;
        }

        body.dark-mode {
            background: #121212;
            color: #f0f0f0;
        }

            body.dark-mode .section {
                background: #1e1e1e;
                color: #f0f0f0;
                border-color: #444;
            }

            body.dark-mode .section-content {
                background: #2b2b2b;
            }

            body.dark-mode table {
                color: #f0f0f0;
            }

            body.dark-mode thead {
                background: #034a61;
            }

            body.dark-mode .modal-content {
                background: #2b2b2b;
                color: #f0f0f0;
            }

                body.dark-mode .modal-content label {
                    color: #f0f0f0;
                }

                body.dark-mode .modal-content input,
                body.dark-mode .modal-content select {
                    background: #3b3b3b;
                    color: #f0f0f0;
                    border-color: #555;
                }

            body.dark-mode .menu-options {
                background: #2b2b2b;
                color: #f0f0f0;
            }

                body.dark-mode .menu-options button {
                    color: #f0f0f0;
                }

                    body.dark-mode .menu-options button:hover {
                        background: #3b3b3b;
                    }

            body.dark-mode .date-container label {
                color: #f0f0f0;
            }

            body.dark-mode .date-container input {
                background: #3b3b3b;
                color: #f0f0f0;
                border-color: #555;
            }

            body.dark-mode .close-btn {
                background: #3b3b3b;
                color: #f0f0f0;
            }

                body.dark-mode .close-btn:hover {
                    background: #4b4b4b;
                }

            body.dark-mode #search-results {
                border-color: #444;
            }

            body.dark-mode .search-result-item {
                border-color: #444;
            }

                body.dark-mode .search-result-item:hover {
                    background: #3b3b3b;
                }

            body.dark-mode .search-result-header {
                color: #48a6cb;
            }

            body.dark-mode .search-result-details {
                color: #bbb;
            }

            body.dark-mode .autocomplete-items {
                background: #3b3b3b;
                border-color: #555;
            }

                body.dark-mode .autocomplete-items div {
                    border-color: #555;
                    color: #f0f0f0;
                }

                    body.dark-mode .autocomplete-items div:hover {
                        background-color: #4b4b4b;
                    }

        @media (max-width: 600px) {
            header {
                font-size: 2rem;
                padding: 0 10px;
            }

            .section-header {
                font-size: 1.15rem;
                padding: 16px 18px;
            }

            table th, table td {
                font-size: 0.9rem;
                padding: 8px 10px;
            }

            .modal-content {
                padding: 24px;
                max-width: 95%;
            }

                .modal-content h3 {
                    font-size: 1.5rem;
                    margin-bottom: 18px;
                }

                .modal-content button[type="submit"],
                .close-btn {
                    font-size: 1.05rem;
                    padding: 12px 0;
                }

            .floating-menu {
                top: 10px;
                right: 10px;
            }

            .date-container {
                flex-direction: column;
                gap: 5px;
            }

            .menu-options {
                min-width: 160px;
            }

            .total-box {
                bottom: 10px;
                right: 10px;
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>Aqua Esmeralda Beach Club</header>
    <div class="date-container">
        <label for="calendar">Fecha de reservas:</label>
        <input type="date" id="calendar" />
    </div>
    <main class="container">
        <section id="vip" class="section" aria-labelledby="vip-header" aria-expanded="false">
            <button class="section-header accordion-btn" aria-controls="vip-content" id="vip-header" aria-expanded="false" aria-haspopup="true">
                <span>Reservas VIP</span>
                <span class="count" aria-live="polite" aria-atomic="true" id="vip-count">0</span>
            </button>
            <div class="section-content content" id="vip-content" role="region" aria-hidden="true">
                <table aria-describedby="vip-desc" role="table">
                    <caption id="vip-desc" class="sr-only">Lista de reservas para zona VIP</caption>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn" aria-label="Agregar reserva en VIP">Agregar Reserva</button>
            </div>
        </section>
        <section id="regular" class="section" aria-labelledby="regular-header" aria-expanded="false">
            <button class="section-header accordion-btn" aria-controls="regular-content" id="regular-header" aria-expanded="false" aria-haspopup="true">
                <span>Reservas Regular</span>
                <span class="count" aria-live="polite" aria-atomic="true" id="regular-count">0</span>
            </button>
            <div class="section-content content" id="regular-content" role="region" aria-hidden="true">
                <table aria-describedby="regular-desc" role="table">
                    <caption id="regular-desc" class="sr-only">Lista de reservas para zona Regular</caption>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn" aria-label="Agregar reserva en Regular">Agregar Reserva</button>
            </div>
        </section>
        <section id="restaurante" class="section" aria-labelledby="restaurante-header" aria-expanded="false">
            <button class="section-header accordion-btn" aria-controls="restaurante-content" id="restaurante-header" aria-expanded="false" aria-haspopup="true">
                <span>Reservas Restaurante</span>
                <span class="count" aria-live="polite" aria-atomic="true" id="restaurante-count">0</span>
            </button>
            <div class="section-content content" id="restaurante-content" role="region" aria-hidden="true">
                <table aria-describedby="restaurante-desc" role="table">
                    <caption id="restaurante-desc" class="sr-only">Lista de reservas para zona Restaurante</caption>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Carnet</th>
                            <th>Hora</th>
                            <th>Personas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button class="add-btn" aria-label="Agregar reserva en Restaurante">Agregar Reserva</button>
            </div>
        </section>
    </main>

    <div id="total-general" aria-live="polite" aria-atomic="true">
        Total general de personas (sin reservas canceladas): 0
    </div>

    <div id="form-container" class="modal" role="dialog" aria-modal="true" aria-labelledby="form-title" aria-describedby="form-desc">
        <div class="modal-content">
            <form id="form">
                <h3 id="form-title">Agregar reserva</h3>
                <p id="form-desc" class="sr-only">Formulario para agregar o editar una reserva.</p>
                <div class="autocomplete">
                    <label for="input-nombre">Nombre</label>
                    <input id="input-nombre" name="nombre" type="text" autocomplete="off" required />
                    <div id="nombre-autocomplete" class="autocomplete-items"></div>
                </div>

                <label for="input-carnet">Carnet (opcional)</label>
                <input id="input-carnet" name="carnet" type="text" autocomplete="off" />

                <label for="input-hora">Hora</label>
                <input id="input-hora" name="hora" type="time" required />

                <label for="input-personas">Personas</label>
                <input id="input-personas" name="personas" type="number" min="1" required />

                <label for="input-estado">Estado</label>
                <select id="input-estado" name="estado" required>
                    <option value="pending">Pendiente</option>
                    <option value="arrived">Llegó</option>
                    <option value="cancelled">Cancelado</option>
                </select>

                <button type="submit">Guardar</button>
                <button type="button" class="close-btn" aria-label="Cerrar formulario">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal de búsqueda -->
    <div id="search-container" class="modal" role="dialog" aria-modal="true" aria-labelledby="search-title">
        <div class="modal-content">
            <form id="search-form">
                <h3 id="search-title"><i class="fas fa-search"></i> Buscar Cliente</h3>
                <label for="search-input">Nombre del cliente:</label>
                <input type="text" id="search-input" placeholder="Escribe el nombre..." />
                <button type="button" id="search-button">Buscar</button>
                <div id="search-results"></div>
                <button type="button" class="close-btn" style="margin-top: 20px;">Cerrar</button>
            </form>
        </div>
    </div>

    <!-- Botón de opciones -->
    <div class="floating-menu">
        <div class="menu-button" id="menu-button">⋮</div>
        <div class="menu-options" id="menu-options">
            <button><i class="fas fa-moon"></i> Modo oscuro</button>
            <button><i class="fas fa-search"></i> Buscar cliente</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURACIÓN =====
        const API_URL = 'https://script.google.com/macros/s/AKfycbzf0YCqkbOZZ0I6DgnXzbBQJwP6E5CkHlbiTUxxsa5R-Kc7z9YQhgW9m9YpDIH47zg4/exec'; // Reemplaza con tu URL de Apps Script
        const sections = ['vip', 'regular', 'restaurante'];
        let currentDate = new Date().toISOString().split('T')[0];
        let editSection = null;
        let editIndex = null;
        let data = {};

        // ===== FUNCIONES PARA EL MENÚ =====
        document.getElementById('menu-button').addEventListener('click', function (e) {
            e.stopPropagation(); // Evita que el evento se propague al documento
            const menu = document.getElementById('menu-options');
            menu.classList.toggle('active');

            if (menu.classList.contains('active')) {
                menu.style.transform = 'translateY(0)';
                menu.style.opacity = '1';
                menu.style.visibility = 'visible';
            } else {
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
            }
        });

        // Cerrar menú al hacer clic fuera
        document.addEventListener('click', function () {
            const menu = document.getElementById('menu-options');
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
            }
        });

        // Evitar que el menú se cierre al hacer clic dentro de él
        document.getElementById('menu-options').addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Funcionalidad de los botones del menú
        document.querySelectorAll('#menu-options button').forEach((button, index) => {
            button.addEventListener('click', function () {
                if (index === 0) {
                    toggleDarkMode();
                } else if (index === 1) {
                    openSearch();
                }

                // Cerrar el menú después de seleccionar una opción
                const menu = document.getElementById('menu-options');
                menu.classList.remove('active');
                menu.style.transform = 'translateY(-20px)';
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
            });
        });

        // ===== FUNCIONES PARA GOOGLE SHEETS =====
        async function fetchFromGoogleSheets(params = {}) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const response = await fetch(`${API_URL}?${queryString}`);

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                return await response.json();
            } catch (error) {
                console.error('Error al comunicarse con Google Sheets:', error);
                throw error;
            }
        }

        async function loadAllData() {
            try {
                const result = await fetchFromGoogleSheets({
                    operation: 'getData'
                });

                data = result;
                loadDataForDate(currentDate);
            } catch (error) {
                console.error('Error al cargar datos:', error);
                // Fallback a localStorage
                const savedData = localStorage.getItem('beachClubData');
                if (savedData) {
                    data = JSON.parse(savedData);
                }
            }
        }

        async function saveAllData() {
            localStorage.setItem('beachClubData', JSON.stringify(data));
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? '1' : '0');
        }

        async function addReservation(date, section, reservation) {
            try {
                await fetchFromGoogleSheets({
                    operation: 'addReservation',
                    date: date,
                    section: section,
                    reservation: JSON.stringify(reservation)
                });

                if (!data[date]) {
                    data[date] = { vip: [], regular: [], restaurante: [] };
                }
                data[date][section].push(reservation);

                return true;
            } catch (error) {
                console.error('Error al añadir reserva:', error);
                throw error;
            }
        }

        async function updateReservation(date, section, index, updatedReservation) {
            try {
                await fetchFromGoogleSheets({
                    operation: 'updateReservation',
                    date: date,
                    section: section,
                    index: index,
                    reservation: JSON.stringify(updatedReservation)
                });

                data[date][section][index] = updatedReservation;

                return true;
            } catch (error) {
                console.error('Error al actualizar reserva:', error);
                throw error;
            }
        }

        // ===== FUNCIONES PRINCIPALES =====
        function getCurrentDateData() {
            if (!data[currentDate]) {
                data[currentDate] = {
                    vip: [],
                    regular: [],
                    restaurante: []
                };
            }
            return data[currentDate];
        }

        function loadDataForDate(date) {
            currentDate = date;
            document.getElementById('calendar').value = date;

            if (!data[date]) {
                data[date] = {
                    vip: [],
                    regular: [],
                    restaurante: []
                };
            }

            sections.forEach(sec => renderSection(sec));
            updateTotalGeneral();
        }

        function renderSection(section) {
            const tbody = document.querySelector(`#${section} tbody`);
            tbody.innerHTML = '';

            const currentData = getCurrentDateData();
            const sectionData = currentData[section] || [];

            sectionData.forEach((reserva, i) => {
                const tr = document.createElement('tr');
                tr.tabIndex = 0;
                tr.className = reserva.estado;
                tr.setAttribute('role', 'row');
                tr.setAttribute('aria-label', `${reserva.nombre}, ${reserva.carnet || 'Sin carnet'}, ${reserva.hora}, ${reserva.personas} personas, estado: ${estadoTexto(reserva.estado)}`);

                tr.addEventListener('click', () => openEditForm(section, i));
                tr.addEventListener('keypress', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        openEditForm(section, i);
                    }
                });

                tr.innerHTML = `
          <td>${reserva.nombre}</td>
          <td>${reserva.carnet || ''}</td>
          <td>${reserva.hora}</td>
          <td>${reserva.personas}</td>
          <td>${estadoTexto(reserva.estado)}</td>
        `;
                tbody.appendChild(tr);
            });

            document.getElementById(`${section}-count`).textContent = sectionData.length;
        }

        function updateTotalGeneral() {
            let total = 0;
            const currentData = getCurrentDateData();

            sections.forEach(sec => {
                (currentData[sec] || []).forEach(reserva => {
                    if (reserva.estado !== 'cancelled') {
                        total += Number(reserva.personas);
                    }
                });
            });

            document.getElementById('total-general').textContent = `Total general de personas (sin reservas canceladas): ${total}`;
        }

        function estadoTexto(estado) {
            switch (estado) {
                case 'pending': return 'Pendiente';
                case 'arrived': return 'Llegó';
                case 'cancelled': return 'Cancelado';
                default: return '';
            }
        }

        function capitalize(text) {
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        // ===== MANEJO DE FORMULARIOS =====
        async function handleFormSubmit(e) {
            e.preventDefault();

            const form = e.target;
            const newReserva = {
                nombre: form.nombre.value.trim(),
                carnet: form.carnet.value.trim() || null,
                hora: form.hora.value,
                personas: Number(form.personas.value),
                estado: form.estado.value
            };

            if (!newReserva.nombre || newReserva.nombre.length < 3) {
                alert("El nombre debe tener al menos 3 caracteres");
                return;
            }

            if (newReserva.personas < 1 || newReserva.personas > 20) {
                alert("Número de personas inválido (1-20)");
                return;
            }

            try {
                if (editIndex !== null) {
                    await updateReservation(currentDate, editSection, editIndex, newReserva);
                } else {
                    await addReservation(currentDate, editSection, newReserva);
                }

                renderSection(editSection);
                updateTotalGeneral();
                closeForm();
            } catch (error) {
                console.error('Error al guardar reserva:', error);
                alert("Error al guardar la reserva. Por favor intenta nuevamente.");
            }
        }

        function openAddForm(section) {
            editSection = section;
            editIndex = null;

            const form = document.getElementById('form');
            form.reset();
            form.querySelector('h3').textContent = `Agregar reserva en ${capitalize(section)}`;
            form.querySelector('button[type="submit"]').textContent = 'Agregar';

            document.getElementById('form-container').classList.add('active');
            document.getElementById('input-nombre').focus();
        }

        function openEditForm(section, index) {
            editSection = section;
            editIndex = index;

            const currentData = getCurrentDateData();
            const item = currentData[section][index];
            const form = document.getElementById('form');

            form.querySelector('h3').textContent = `Editar reserva en ${capitalize(section)}`;
            form.querySelector('button[type="submit"]').textContent = 'Guardar cambios';

            form['nombre'].value = item.nombre;
            form['carnet'].value = item.carnet || '';
            form['hora'].value = item.hora;
            form['personas'].value = item.personas;
            form['estado'].value = item.estado;

            document.getElementById('form-container').classList.add('active');
            document.getElementById('input-nombre').focus();
        }

        function closeForm() {
            document.getElementById('form-container').classList.remove('active');
            editSection = null;
            editIndex = null;
            document.getElementById('form').reset();
            document.getElementById('nombre-autocomplete').innerHTML = '';
        }

        // ===== BÚSQUEDA =====
        function openSearch() {
            document.getElementById('search-container').classList.add('active');
            document.getElementById('search-input').focus();
        }

        function closeSearch() {
            document.getElementById('search-container').classList.remove('active');
            document.getElementById('search-results').innerHTML = '';
        }

        document.getElementById('search-button').addEventListener('click', searchClient);
        document.querySelector('#search-form .close-btn').addEventListener('click', closeSearch);

        function searchClient() {
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            if (!searchTerm) return;

            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';

            let foundClients = {};

            for (const date in data) {
                sections.forEach(section => {
                    const reservations = data[date][section] || [];

                    reservations.forEach(reservation => {
                        if (reservation.nombre.toLowerCase().includes(searchTerm)) {
                            if (!foundClients[reservation.nombre]) {
                                foundClients[reservation.nombre] = {
                                    carnet: reservation.carnet,
                                    reservations: []
                                };
                            }

                            foundClients[reservation.nombre].reservations.push({
                                date,
                                section,
                                hora: reservation.hora,
                                personas: reservation.personas,
                                estado: reservation.estado
                            });
                        }
                    });
                });
            }

            if (Object.keys(foundClients).length === 0) {
                resultsContainer.innerHTML = '<p>No se encontraron clientes con ese nombre.</p>';
                return;
            }

            for (const nombre in foundClients) {
                const client = foundClients[nombre];
                const clientElement = document.createElement('div');
                clientElement.className = 'search-result-item';

                let html = `
          <div class="search-result-header">
            <span>${nombre}</span>
            ${client.carnet ? `<span>Carnet: ${client.carnet}</span>` : ''}
          </div>
          <div class="search-result-details">
        `;

                client.reservations.sort((a, b) => new Date(b.date) - new Date(a.date));

                client.reservations.forEach(res => {
                    const fechaFormateada = new Date(res.date).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    html += `
            <div>
              <strong>${fechaFormateada}</strong> -
              ${capitalize(res.section)} |
              ${res.hora} |
              ${res.personas} persona${res.personas > 1 ? 's' : ''} |
              Estado: ${estadoTexto(res.estado)}
            </div>
          `;
                });

                html += `</div>`;
                clientElement.innerHTML = html;
                resultsContainer.appendChild(clientElement);
            }
        }

        // ===== AUTCOMPLETADO =====
        document.getElementById('input-nombre').addEventListener('input', function () {
            const input = this.value.trim();
            const autocompleteList = document.getElementById('nombre-autocomplete');
            autocompleteList.innerHTML = '';

            if (input.length < 2) return;

            const names = new Set();

            for (const date in data) {
                sections.forEach(section => {
                    const reservations = data[date][section] || [];
                    reservations.forEach(reservation => {
                        if (reservation.nombre.toLowerCase().includes(input.toLowerCase())) {
                            names.add(reservation.nombre);
                        }
                    });
                });
            }

            if (names.size === 0) return;

            names.forEach(name => {
                const item = document.createElement('div');
                item.textContent = name;
                item.addEventListener('click', function () {
                    document.getElementById('input-nombre').value = name;

                    let latestReservation = null;
                    for (const date in data) {
                        sections.forEach(section => {
                            const reservations = data[date][section] || [];
                            reservations.forEach(reservation => {
                                if (reservation.nombre === name && reservation.carnet) {
                                    if (!latestReservation || new Date(date) > new Date(latestReservation.date)) {
                                        latestReservation = reservation;
                                    }
                                }
                            });
                        });
                    }

                    if (latestReservation) {
                        document.getElementById('input-carnet').value = latestReservation.carnet;
                    }

                    autocompleteList.innerHTML = '';
                });
                autocompleteList.appendChild(item);
            });
        });

        document.addEventListener('click', function (e) {
            if (e.target.id !== 'input-nombre') {
                document.getElementById('nombre-autocomplete').innerHTML = '';
            }
        });

        // ===== MODO OSCURO =====
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            saveAllData();
        }

        // ===== INICIALIZACIÓN =====
        function init() {
            // Configurar calendario
            const calendar = document.getElementById('calendar');
            calendar.value = currentDate;

            calendar.addEventListener('change', (e) => {
                currentDate = e.target.value;
                loadDataForDate(currentDate);
            });

            // Inicializar acordeones
            sections.forEach(sec => {
                const btn = document.querySelector(`#${sec} > .accordion-btn`);
                const content = document.getElementById(`${sec}-content`);

                btn.addEventListener('click', () => {
                    const expanded = btn.getAttribute('aria-expanded') === 'true';
                    btn.setAttribute('aria-expanded', !expanded);
                    content.classList.toggle('active');
                    content.setAttribute('aria-hidden', expanded);
                    document.getElementById(sec).classList.toggle('expanded');
                });

                btn.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });

            // Botones agregar
            sections.forEach(sec => {
                document.querySelector(`#${sec} .add-btn`).addEventListener('click', () => openAddForm(sec));
            });

            // Formulario
            document.getElementById('form').addEventListener('submit', handleFormSubmit);
            document.querySelector('#form .close-btn').addEventListener('click', closeForm);

            // Búsqueda
            document.getElementById('search-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchClient();
                }
            });

            // Cargar datos
            loadAllData();

            // Inicializar modo oscuro
            if (localStorage.getItem('darkMode') === '1') {
                document.body.classList.add('dark-mode');
            }
        }

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>